<!DOCTYPE html>
<html>
<head>
    <title>–ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–∫—É–ø–∫–∏ —Å UTM –º–µ—Ç–∫–∞–º–∏</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
    <h1>üß™ –¢–ï–°–¢ –° UTM –ú–ï–¢–ö–ê–ú–ò</h1>
    <p>–≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–∫—É–ø–∫–∏ —Å UTM –º–µ—Ç–∫–∞–º–∏</p>
    
    <button id="checkout-button">üí≥ –°–æ–∑–¥–∞—Ç—å –ø–æ–∫—É–ø–∫—É —Å UTM –º–µ—Ç–∫–∞–º–∏</button>
    
    <div id="result"></div>
    
    <script>
        const stripe = Stripe('pk_live_51S95aiLGc4AZl8D4IfCxsG3jXoxrEsFJS7vMFijyGIzOMG8TLHQpqEuuofT2wEAnyiEpoR8fSrDBA30Q1xYiBH2c00megrfMxz');
        
        document.getElementById('checkout-button').addEventListener('click', async () => {
            try {
                // URL —Å UTM –º–µ—Ç–∫–∞–º–∏ (–∫–∞–∫ –≤ –≤–∞—à–µ–π —Ä–µ–∫–ª–∞–º–µ)
                const referrerUrl = 'https://example.com/checkout?utm_source=meta&utm_medium={{placement}}&utm_campaign={{campaign.name}}&campaign_id={{campaign.id}}&adset_name={{adset.name}}&adset_id={{adset.id}}&ad_name={{ad.name}}&ad_id={{ad.id}}&publisher_site_id={{site_source_name}}&gender=Female&age=30-44&product_tag=regular-plan-1&creative_link=Creo Link&platform_placement=Instagram_Feed';
                
                const response = await fetch('https://stripe-ops.onrender.com/api/create-checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        price_data: {
                            currency: 'usd',
                            product_name: 'Test Product with UTM',
                            unit_amount: 999, // $9.99
                        },
                        quantity: 1,
                        success_url: 'https://stripe-ops.onrender.com/success',
                        cancel_url: 'https://stripe-ops.onrender.com/cancel',
                        referrer_url: referrerUrl
                    })
                });
                
                const session = await response.json();
                
                if (session.id) {
                    document.getElementById('result').innerHTML = '<p>‚úÖ –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...</p>';
                    console.log('Session metadata:', session.metadata);
                    
                    const result = await stripe.redirectToCheckout({
                        sessionId: session.id
                    });
                    
                    if (result.error) {
                        document.getElementById('result').innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞: ' + result.error.message + '</p>';
                    }
                } else {
                    document.getElementById('result').innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏: ' + JSON.stringify(session) + '</p>';
                }
            } catch (error) {
                document.getElementById('result').innerHTML = '<p>‚ùå –û—à–∏–±–∫–∞: ' + error.message + '</p>';
            }
        });
    </script>
</body>
</html>
